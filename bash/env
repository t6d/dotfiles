#!/usr/bin/env bash

# --------------------------------------------------------------------------
# Helpers
# --------------------------------------------------------------------------

function __is_directory() {
  [[ -z $1 ]] && return 1
  
  if [[ -d $1 ]] || [[ -L $1 && -d $1/`readlink $1` ]]; then
    return 0
  else
    return 1
  fi
}

function __add_path() {
  local pattern="^(.*:)?$1(:.*)?$"
  
  if __is_directory $1 && [[ ! $PATH =~ $pattern ]]; then
    export PATH=$1:$PATH
  fi
}

function __remove_path() {
  local slash=/
  local path=${1/%$slash/}
  local path_with_slash=$path/
  
  # replace all occurrences of :<path>: with :
  PATH=${PATH//:$path:/:}
  PATH=${PATH//:$path_with_slash:/:}
  
  # remove trailing :<path>
  PATH=${PATH/%:$path}
  PATH=${PATH/%:$path_with_slash}
  
  # remove leading <path>:
  PATH=${PATH/#$path:}
  PATH=${PATH/#$path_with_slash:}
  
  export PATH
}

function __rvm_is_loaded() {
  if which rvm > /dev/null 2>&1; then
    return 0
  else
    return 1
  fi
}

# --------------------------------------------------------------------------
# Common settings
# --------------------------------------------------------------------------

# -- Locale settings -------------------------------------------------------

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# -- RVM -------------------------------------------------------------------

if ! __rvm_is_loaded; then
  if [[ -s "$HOME/.rvm/scripts/rvm" ]]; then
    source "$HOME/.rvm/scripts/rvm"
  elif [[ -s "/usr/local/rvm/scripts/rvm" ]]; then
    source "/usr/local/rvm/scripts/rvm"
  else
    echo "RVM not found!"
  fi
fi

[[ -r $rvm_path/scripts/completion ]] && . $rvm_path/scripts/completion

# -- Directory colors ------------------------------------------------------

LS_COLORS=""
LS_COLORS=$LS_COLORS:"di=01;36:ln=01;04:ex=01;32:mi=01;30"
LS_COLORS=$LS_COLORS:"*.dmg=01;33:*.rar=01;33:*.tar.gz=01;33:*tar.bz2=01;33"
LS_COLORS=$LS_COLORS:"*.tgz=01;33:*.zip=01;33"
LS_COLORS=$LS_COLORS:"*.c=01;31:*.cpp=01;31:*.h=01;31:*.m=01;31:*.rb=01;31"
LS_COLORS=$LS_COLORS:"*.rb=01;31:*.xcodeproj=01;31"
export LS_COLORS

# -- Word-wise erasing -----------------------------------------------------

stty werase undef
bind '"\C-w":backward-kill-word'

# --------------------------------------------------------------------------
# System specific settings
# --------------------------------------------------------------------------

[[ -f ~/.bash/env.d/$(uname) ]] && source ~/.bash/env.d/$(uname)

# --------------------------------------------------------------------------
# Path settings (~/bin)
# --------------------------------------------------------------------------

__remove_path "$HOME/bin"
__add_path "$HOME/bin"

# --------------------------------------------------------------------------
# Tear down
# --------------------------------------------------------------------------

unset __is_directory
unset __add_path
unset __remove_path
unset __rvm_is_loaded
